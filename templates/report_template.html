<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pattern Analyzer Analysis Report</title>

  <!-- Bootstrap 5 and Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <style>
    :root { --bs-body-font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
    body { background-color: #f8f9fa; }
    .card { box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: none; }
    .score-metric { font-size: 1.5rem; font-weight: 700; }
    .small-mono { font-family: 'Fira Code', 'Roboto Mono', monospace; background-color: #e9ecef; padding: .2em .4em; border-radius: 4px; }
    .help-icon { cursor: pointer; color: #6c757d; transition: color 0.2s; }
    .help-icon:hover { color: #0d6efd; }
    .table-hover tbody tr:hover { background-color: rgba(0,0,0,0.04); }
    .badge.bg-success-subtle { color: #0a3622 !important; border: 1px solid #a3cfbb; }
    .badge.bg-danger-subtle { color: #58151c !important; border: 1px solid #f1b4b9; }
    .badge.bg-secondary-subtle { color: #212529 !important; border: 1px solid #d3d6d9; }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="pb-3 mb-4 border-bottom">
      <h1 class="h3">Pattern Analyzer Analysis Report</h1>
      <p class="text-muted mb-0">Generation Time: <span class="small-mono">{{ meta.get("generated_at", "N/A") }}</span></p>
    </header>

    <section id="analysis-summary" class="card p-3 mb-4">
        <h5 class="card-title">Analysis Summary</h5>
        {% set failed_count = scorecard.get("failed_tests", 0) %}
        {% if failed_count > 0 %}
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Potential Anomalies Detected!</h4>
                <p>Out of a total of <strong>{{ scorecard.get("total_tests", 0) }}</strong> tests, <strong>{{ failed_count }}</strong> showed statistically significant deviations (FDR q={{ scorecard.get("fdr_q") }}). This suggests that the analyzed data may not be entirely random.</p>
                <hr>
                <p class="mb-1"><strong>Failed Tests:</strong></p>
                <ul>
                    {% for result in results %}
                        {% if result.fdr_rejected %}
                            <li><strong>{{ result.test_name }}</strong>: Failure in this test usually indicates a specific pattern in the data. For detailed information, click the <i class="bi bi-question-circle-fill help-icon" data-plugin-key="{{ result.test_name }}"></i> icon in the table.</li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
        {% else %}
            <div class="alert alert-success" role="alert">
                <h4 class="alert-heading"><i class="bi bi-check-circle-fill"></i> No Anomalies Detected</h4>
                <p>None of the <strong>{{ scorecard.get("total_tests", 0) }}</strong> tests run showed statistical anomalies at the specified significance level. The data exhibits a random structure within the scope of these tests.</p>
            </div>
        {% endif %}
    </section>

    <section class="row g-4 mb-4">
      <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
          <h5 class="card-title">Scorecard</h5>
          <div class="d-flex align-items-center justify-content-around flex-wrap text-center">
            <div class="p-2">
              <div class="text-muted small">FAILED TESTS</div>
              <div class="score-metric text-danger">{{ scorecard.get("failed_tests", 0) }}</div>
            </div>
            <div class="p-2">
              <div class="text-muted small">TOTAL TESTS</div>
              <div class="score-metric">{{ scorecard.get("total_tests", 0) }}</div>
            </div>
            <div class="p-2">
              <div class="text-muted small">FDR (q)</div>
              <div class="score-metric">{{ scorecard.get("fdr_q") }}</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card p-3 h-100">
          <h5 class="card-title">P-Value Distribution</h5>
          <div style="height: 150px;"><canvas id="pvalChart"></canvas></div>
        </div>
      </div>
    </section>

    <section class="card p-3 mb-4">
      <h5 class="card-title mb-3">Detailed Test Results</h5>
      <div class="table-responsive">
        <table id="resultsTable" class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Test Name</th>
              <th class="text-center">Result</th>
              <th>P-Value</th>
              <th class="text-center">Details</th>
            </tr>
          </thead>
          <tbody>
            {% for result in results %}
            <tr>
              <td>
                {{ result.test_name }}
                <i class="bi bi-question-circle-fill ms-2 help-icon" 
                   data-plugin-key="{{ result.test_name }}" 
                   data-bs-target="#details-{{ loop.index }}"
                   title="Learn what this test means"></i>
              </td>
              <td class="text-center">
                {% if result.status != 'completed' %}
                    <span class="badge bg-secondary-subtle rounded-pill">{{ result.status | upper }}</span>
                {% elif result.fdr_rejected %}
                    <span class="badge bg-danger-subtle rounded-pill">FAIL</span>
                {% else %}
                    <span class="badge bg-success-subtle rounded-pill">PASS</span>
                {% endif %}
              </td>
              <td><span class="small-mono">{{ "%.4g" % result.p_value if result.p_value is not none else "N/A" }}</span></td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#details-{{ loop.index }}">
                  <i class="bi bi-arrows-angle-expand"></i> Show
                </button>
              </td>
            </tr>
            <tr class="collapse-row">
              <td colspan="4" class="p-0">
                <div class="collapse" id="details-{{ loop.index }}">
                  <div class="p-3 bg-light border-top">
                    <div class="description-area mb-3 p-3 bg-white rounded border"></div>
                    <div class="row">
                        <div class="col-12 col-md-7">
                            <h6>Metrics</h6>
                            <pre class="small bg-white p-2 rounded border" style="max-height: 300px;">{{ result._lite_metrics | tojson(indent=2) }}</pre>
                        </div>
                        <div class="col-12 col-md-5">
                            {% if result.visuals %}
                                <h6 class="mt-3 mt-md-0">Visual</h6>
                                {% for vname, v in result.visuals.items() %}
                                    {% if v.data_base64 %}
                                        <img class="img-fluid rounded border" alt="{{ vname }}" src="data:{{ v.mime }};base64,{{ v.data_base64 }}" />
                                    {% elif v.path %}
                                        <img class="img-fluid rounded border" alt="{{ vname }}" src="{{ v.path }}" />
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Metadata (Collapsible) -->
    <div class="accordion" id="metaAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMeta">
              Runtime Environment and Metadata
            </button>
          </h2>
          <div id="collapseMeta" class="accordion-collapse collapse">
            <div class="accordion-body">
                <div class="table-responsive small">
                    <table class="table table-sm table-bordered">
                      {% for k, v in meta.items() %}
                      <tr>
                        <th style="width: 20%;">{{ k }}</th>
                        <td><pre class="small bg-light p-1 rounded mb-0">{{ v | tojson(indent=2) }}</pre></td>
                      </tr>
                      {% endfor %}
                    </table>
                </div>
            </div>
          </div>
        </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  
  <script id="pHistData" type="application/json">{{ p_hist_series | tojson | safe }}</script>
  <script id="pluginDescriptions" type="application/json">{{ descriptions | tojson | safe }}</script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const descriptions = JSON.parse(document.getElementById('pluginDescriptions').textContent);
      
      document.querySelectorAll('.help-icon').forEach(btn => {
        btn.addEventListener('click', () => {
          const key = btn.dataset.pluginKey;
          const targetId = btn.dataset.bsTarget;
          const detailsDiv = document.querySelector(targetId);
          if (!detailsDiv) return;

          const descriptionArea = detailsDiv.querySelector('.description-area');
          const d = descriptions[key] || { title: key, short: 'No description found for this test.', long: '', remediation: '' };
          
          descriptionArea.innerHTML = `
            <h5 class="mb-2">${d.title}</h5>
            <p class="mb-2"><strong>What Does It Mean?</strong> ${d.short}</p>
            <p class="small text-muted">${d.long || ''}</p>
            ${d.remediation ? `<p class="small"><strong>Suggestion:</strong> ${d.remediation}</p>` : ''}
          `;
          
          // Show the collapse area
          const collapseInstance = bootstrap.Collapse.getOrCreateInstance(detailsDiv);
          collapseInstance.show();
        });
      });

      const pHistData = JSON.parse(document.getElementById('pHistData').textContent);
      const pvalCtx = document.getElementById('pvalChart').getContext('2d');
      new Chart(pvalCtx, {
        type: 'bar',
        data: {
          labels: ['< 0.01 (Significant)', '0.01-0.05', '0.05-0.1', '> 0.1 (Insignificant)'],
          datasets: [{
            label: 'P-Value Count',
            data: pHistData,
            backgroundColor: ['#d9534f', '#f0ad4e', '#5bc0de', '#5cb85c'],
          }]
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
      });
    });
  </script>
</body>
</html>